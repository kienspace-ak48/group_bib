<div class="page-header">
    <div class="page-block">
        <div class="row align-items-center">
            <div class="col-md-12">
                <div class="page-header-title">
                    <h5 class="m-b-10">Event</h5>
                </div>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#!">Post</a></li>
                    <li class="breadcrumb-item"><a href="#!">create new post</a></li>
                    <!-- <li class="breadcrumb-item" aria-current="page">Home</li> -->
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- breack-crum -->
<div class="progress-container">
    <div class="progressbar">
        <div class="progress-line" id="progress-line"></div>

        <a href="/admin/event/form-edit/<%=event_slug%>">
            <div data-step="1" class="progress-step active">1. Initial</div>
        </a>
        <!--  -->
        <%if(event && event.race_function){%> <%if(event.race_function ==='ticket'){%>
        <a href="/admin/event/<%=event_slug%>/athlete-data">
            <div data-step="2" class="progress-step">2. Manage Athlete</div>
        </a>
        <%}else{%>
        <a href="/admin/event/type-checkin/<%=event_slug%>/athlete-data">
            <div data-step="2" class="progress-step">2. Manage Athlete</div>
        </a>
        <%}%> <%}%>
        <!--  -->
        <a href="/admin/event/<%=event_slug%>/type-checkin/send-mail">
            <div data-step="2" class="progress-step">3. Send E-Mail</div>
        </a>
        <!-- <div data-step="3" class="progress-step">3. Send E-mail</div> -->
        <div data-step="4" class="progress-step">4. Check-in</div>
        <div data-step="5" class="progress-step">5. Finish</div>
    </div>
</div>
<!--  -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-item-center">
        <h2>Send Mail</h2>
        <!-- <a class="btn btn-primary" href="/admin/event/form">New event</a> -->
    </div>
    <div class="card-body">
        <button class="btn btn-outline-success" id="btn_sendmail">Send Mail</button>
    </div>
</div>
<div class="card">
    <div class="card-header d-flex justify-content-between align-item-center">
        <h2>Email config</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-6">
                <label for="" class="form-label">Tên sender:</label>
                <input type="text" id="sender_name" value="<%=mc.sender_name%>"  class="form-control" />
                <label for="" class="form-label" >Tiêu đề:</label>
                <input type="text" id="mail_title" value="<%=mc.title%>" class="form-control" />
                <label for="" class="form-label">Content 1</label>
                <!-- <input type="text" class="form-control"> -->
                <textarea name="" id="content_1" class="form-control"><%=mc.content_1%></textarea>
                <label for="" class="form-label">Content 2</label>
                <!-- <input type="text" class="form-control"> -->
                <textarea name="" id="content_2" class="form-control"><%=mc.content_2%></textarea>
                <button id="btn_cta_mailconfig_save" class="mt-3 w-25 btn btn-primary">Save</button>

            </div>
            <div class="col-6">
                <div class="form-check mb-2" >
                    <input type="checkbox" class="form-check-input" name="" id="banner_option" <%= mc.banner_option ? 'checked' : ''%> /> 
                    <label class="form-check-label" for="defaultCheck1">
                        Tick = Hình
                    </label>
                </div>
                
                <!-- <label for="" class="form-label">Banner Text</label> -->
                <input type="text" class="form-control" id="banner_text" value="<%=mc.banner_text%>" />
                <hr />
                <div class="row pb-3">
                    <div class="col-8">
                        <input type="input" name="" value="<%=mc.banner_img%>" disabled class="form-control" id="banner_img_hidden">
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-info" id="btn_cta_upload_img">upload image</button>
                    </div>
                </div>
                <!-- Preview -->
                <%if(mc._banner_img !=""){%>
                    <div id="preview" style="margin-top: 20px; overflow: hidden;">
                    <img id="previewImg" src="<%=mc.banner_img%>" style="width: 100%; display: block; object-fit: cover; border: 1px solid #ccc; "  >
                    <div id="fileInfo"></div>
                </div>
                <%}else{%>
                    <!-- preview -->
                    <div id="preview" style="margin-top: 20px; overflow: hidden;">
                        <img id="previewImg" style="width: 100%; display: none; object-fit: cover; "  >
                        <div id="fileInfo"></div>
                    </div>
                <%}%>
                <!--  -->
                    <label for="banner_img" class="form-control" style="border: 1px dashed #ccc; padding:50px; text-align: center;">
                        <input type="file" accept="image/*" name="banner" id="banner_img" onchange="previewImg(event)" />
                    </label>
                
                
            </div>
        </div>
    </div>
</div>
<!-- ==========script here======= -->
<script>
    // ==global
    const fileInput = document.querySelector('#banner_img');
    const preview = document.querySelector('#previewImg')
    const fileInfo = document.querySelector('#fileInfo');
    //
    function previewImg(event){
        const file = event.target.files[0];
        if(file && file.type.startsWith('image/')){
            const reader = new FileReader();
            reader.onload = function(e){
                preview.src = e.target.result;
                preview.style.display='block';
                // Hiển thị thông tin ảnh
                const sizeInKB = Math.round(file.size / 1024);
                const dimensions = preview.naturalWidth + ' x ' + preview.naturalHeight;
                
                fileInfo.innerHTML = `
                    <div><strong>Tên:</strong> ${file.name}</div>
                    <div><strong>Kích thước:</strong> ${sizeInKB} KB</div>
                    <div><strong>Định dạng:</strong> ${file.type}</div>
                    <div><strong>Kích thước ảnh:</strong> ${dimensions} px</div>
                `;
            }
            reader.readAsDataURL(file)
        }else{
            preview.style.display= 'none'
        }
         // Xử lý khi ảnh load xong để lấy dimensions
        preview.onload = function() {
            if (fileInfo.innerHTML.includes('Kích thước ảnh:')) {
                const dimensions = this.naturalWidth + ' x ' + this.naturalHeight;
                const currentInfo = fileInfo.innerHTML;
                fileInfo.innerHTML = currentInfo.replace(
                    /Kích thước ảnh:.*px/,
                    `Kích thước ảnh: ${dimensions} px`
                );
            }
        };
    }
    //my notification
    function myNotification(title, icon, timer = 2500, position = 'center') {
        Swal.fire({
            title: title,
            icon: icon,
            position: position,
            timer: timer,
        });
    }
    document.querySelector('#btn_sendmail').addEventListener('click', (ev) => {
        $.ajax({
            url: `/admin/event/<%=event_slug%>/type-checkin/send-mail`,
            method: 'POST',
            contentType: 'application/json',
            success: (res) => {
                console.log(res);
            },
            error: (xhr, status, err) => {
                console.log(xhr.responseJSON?.mess || 'Server error');
            },
        });
    });
    // save
    document.querySelector('#btn_cta_mailconfig_save').addEventListener('click', (ev)=>{
        // console.log('hi');
        const payload  ={
            sender_name: document.querySelector('#sender_name').value,
            title: document.querySelector('#mail_title').value,
            content_1: document.querySelector('#content_1').value,
            content_2: document.querySelector('#content_2').value,
            banner_option: document.querySelector('#banner_option').checked,
            banner_text: document.querySelector('#banner_text').value,
            banner_img: document.querySelector('#banner_img_hidden').value,
        }
        console.log(payload);
        $.ajax({
            url:  `/admin/event/<%=event_slug%>/type-checkin/mail-config`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: (res)=>{document.location.reload()},
            error: (xhr, status, err)=>console.log(xhr.responseJSON?.mess||"Server error")
        })
    })
    // upload img
    document.querySelector('#btn_cta_upload_img').addEventListener('click', (ev)=>{
        const payload = new FormData();
        const file =fileInput.files[0];
        if(!file){
            alert('vui long chon file')
            return;
        } 
        payload.append('file', file);
        payload.append('path_img', document.querySelector('#banner_img_hidden').value)
        $.ajax({
            url:`/admin/event/<%=event_slug%>/type-checkin/banner-mail`,
            method: 'POST',
            contentType: false,
            processData: false,
            data: payload,
            success: (res)=>document.location.reload(),
            error: (xhr, status, err)=> console.log(xhr.responseJSON?.mess||'Server error')
        })
    })
    // myNotification('hi', 'success');
</script>
