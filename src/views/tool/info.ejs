<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<script
    src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"
></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
    integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
    crossorigin="anonymous"
></script>
<style>
    * {
        font-family: 'Inter', sans-serif;
    }
    .header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .badge-warning {
        background-color: #fef3c7;
        color: #92400e;
    }
    .badge-success {
        background-color: #d1fae5;
        color: #065f46;
    }
</style>
<body class="bg-gray-50">
    <div class="">
        <!-- Main Content -->
        <main class="m-auto mx-auto px-4 py-2">
            <div class="flex flex-col justify-center gap-3">
                <!-- Left column: Event info -->
                <!-- <div class="lg:w-1/3">
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">S·ª± ki·ªán</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <div class="flex items-center mb-2">
                                    <div class="bg-indigo-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-flag-checkered text-indigo-600"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-700">Test Send Email</h3>
                                </div>
                                <p class="text-gray-600 ml-11">S·ª± ki·ªán g·ª≠i email th·ª≠ nghi·ªám</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center mb-2">
                                    <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-calendar-day text-blue-600"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-700">Th·ªùi gian</h3>
                                </div>
                                <p class="text-gray-600 ml-11">09/01/2026</p>
                            </div>
                            
                        </div>
                    </div>
                    
                </div> -->

                <!-- Right column: Athlete details -->
                <div class="">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <!-- Header with status -->
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6">
                            <div class="flex flex-row md:flex-row justify-between items-start md:items-center">
                                <div>
                                    <h2 class="text-2xl font-bold text-white mb-2"><%=event.name%></h2>
                                    <%if(pc.checkin_status){%>
                                    <div class="inline-flex items-center px-3 py-1 rounded-full mt-4 badge-success">
                                        <i class="fas fa-circle-check mr-2"></i>
                                        <span class="font-medium text-[12px] mt-">ƒê√£ checkin</span>
                                    </div>
                                    <%}else{%>
                                    <div class="inline-flex items-center px-3 py-1 rounded-full mt-4 badge-warning">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <span class="font-medium text-[12px] mt-">Ch∆∞a checkin</span>
                                    </div>
                                    <%}%>
                                </div>

                                <div class="mt-4 md:mt-0">
                                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                                        <p class="text-white text-sm">Category:<%=pc.distance%></p>
                                        <p class="text-white text-2xl font-bold">
                                            CODE: <span class="text-amber-300"><%=pc.bib%></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Athlete details -->
                        <div class="p-6">
                            <div class="grid grid-cols-2 gap-6">
                                <!-- Personal Info -->
                                <div class="space-y-6">
                                    <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Th√¥ng tin c√° nh√¢n</h3>
                                    <input id="code_hidden" type="hidden" value="<%=pc.uid%>" />
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-gray-500">H·ªç t√™n</p>
                                            <span class="text-lg font-semibold text-gray-800"><%=pc.fullname%></span>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Gi·ªõi t√≠nh</p>
                                            <span class="font-medium text-gray-800"><%=pc.gender?'Nam':'N·ªØ'%></span>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Size √°o/V·∫≠t ph·∫©m</p>
                                            <p class="font-medium text-gray-800"><%=pc.tshirt_size%></p>
                                        </div>

                                        <div>
                                            <p class="text-sm text-gray-500">Nickname</p>
                                            <div
                                                class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-medium"
                                            >
                                                <i class="fas fa-id-badge mr-2"></i>
                                                <%=pc.bib_name%>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Info -->
                                <div class="space-y-6">
                                    <h3 class="text-lg font-bold text-gray-800 border-b pb-2">Th√¥ng tin li√™n h·ªá</h3>

                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-gray-500">CCCD/Passport</p>
                                            <p class="font-mono text-lg font-semibold text-gray-800"><%=pc.cccd%></p>
                                        </div>

                                        <div>
                                            <p class="text-sm text-gray-500">Ng√†y sinh</p>
                                            <div class="flex items-center">
                                                <i class="fas fa-birthday-cake text-purple-500 mr-2"></i>
                                                <p class="font-medium text-gray-800"><%=pc.dob%></p>
                                            </div>
                                        </div>

                                        <div>
                                            <p class="text-sm text-gray-500">S·ªë ƒëi·ªán tho·∫°i</p>
                                            <div class="flex items-center">
                                                <i class="fas fa-phone text-green-500 mr-2"></i>
                                                <p class="font-medium text-gray-800"><%=pc.phone%></p>
                                            </div>
                                        </div>

                                        <div>
                                            <p class="text-sm text-gray-500">Email</p>
                                            <div class="flex items-center">
                                                <i class="fas fa-envelope text-red-500 mr-2"></i>
                                                <p class="font-medium text-gray-800 truncate"><%=pc.email%></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional notes -->
                            <!-- <div class="mt-8 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-circle text-amber-500 text-xl"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-amber-800">L∆∞u √Ω quan tr·ªçng</h3>
                                        <div class="mt-2 text-sm text-amber-700">
                                            <p>V·∫≠n ƒë·ªông vi√™n ch∆∞a k√Ω mi·ªÖn tr·ª´ tr√°ch nhi·ªám. Vui l√≤ng ho√†n t·∫•t th·ªß t·ª•c n√†y tr∆∞·ªõc khi cho ph√©p tham gia s·ª± ki·ªán.</p>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
                <!-- Bot column  -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <button id="btn_cta_openmodal"  class="bg-green-600 text-white px-4 py-2 rounded-lg">
                                    Check-in
                                </button>
                                <!--  -->
                                <div id="previewBoxShow" style="display:none">
                                    <img id="preview" />
                                    <br />
                                    <button id="retake">Ch·ª•p l·∫°i</button>
                                    <button id="upload">Upload</button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <!-- GROUP ACTION -->
                <!-- group acction -->
                <div>
                    <!-- Quick actions footer -->
                    <%if(pc.checkin_status){%>
                    <div class="mt-6 flex gap-4 justify-center items-center">
                        <a href="/tool-checkin" class="justify-center-safe inline-block">
                            <button
                                class="bg-purple-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-700 transition flex items-center justify-center"
                            >
                                <i class="fas fa-edit mr-3"></i>
                                Tr·ªü v·ªÅ
                            </button>
                        </a>
                    </div>

                    <%}else{%>
                    <div class="mt-6 flex flex-row gap-4">
                        <a href="/tool-checkin" class="justify-center-safe flex flex-1">
                            <button
                                class="w-full bg-purple-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-purple-700 transition flex items-center justify-center"
                            >
                                <i class="fas fa-edit mr-3"></i>
                                Tr·ªü v·ªÅ
                            </button>
                        </a>

                        <button
                            id="btn_cta_checkin"
                            class="flex-1 bg-green-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center"
                        >
                            <i class="fas fa-check-circle mr-3"></i>
                            X√°c nh·∫≠n Checkin
                        </button>
                    </div>
                    <%}%>
                </div>
            </div>
        </main>
    </div>

    <!-- ==============MODAL=================== -->
    <!-- Overlay -->
    <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <!-- Modal box -->
        <div class="bg-white rounded-xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="modalBox">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">X√°c nh·∫≠n Check-in</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <!-- Content -->
            <div class="py-6 flex flex-col items-center justify-center gap-10">
                <!-- <p class="text-gray-600 mb-6">
        </p> -->
                <!-- <button class="border border-gray-300 rounded-lg px-4 py-3" id="openCamera">M·ªü camera</button> -->
                <div id="cameraBox">
                    <video id="video" autoplay playsinline class="aspect-video border border-gray-300"></video>
                </div>
                <div id="previewBox" class="w-[80%] h-[auto]" style="display: none">
                    <img id="preview" />
                    <!-- <br /> -->
                    <!-- <button id="retake">Ch·ª•p l·∫°i</button> -->
                    <!-- <button id="upload">Upload</button> -->
                </div>

                <!-- Th√™m canvas ·∫©n ƒë·ªÉ ch·ª•p ·∫£nh -->
                <canvas id="canvas" class="hidden"></canvas>
                <!-- group actins -->
                <div class="flex justify-between w-full">
                    <button id="capture" class="border">ch·ª•p</button>
                    <button id="recapture" class="border">ch·ª•p l·∫°i</button>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex gap-3">
                <button id="btn_close_modal" class="flex-1 border border-gray-300 rounded-lg py-2 hover:bg-gray-100">
                    Hu·ª∑
                </button>

                <button class="flex-1 bg-green-600 text-white rounded-lg py-2 hover:bg-green-700" id="capture_confirm">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!--  -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // global scope
            let stream;
            let tempImage = null;
            const btnCheckin = document.querySelector('#btn_cta_checkin');
            const modal = document.getElementById('modal');
            const modalBox = document.getElementById('modalBox');
            const video = document.querySelector('#video');
            const canvas = document.querySelector('#canvas');
            const preview = document.querySelector('#preview');
            const btnCloseCam = document.querySelector('#closeCamera');
            const btnCaptureCamera = document.querySelector('#capture');
            const btnRetake = document.querySelector('#recapture');
            const btnCaptureConfirm = document.querySelector('#capture_confirm');

            async function openCamera() {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter((x) => x.kind === 'videoinput');
                console.log(videoDevices);
                const selectDeviceId = videoDevices[1].deviceId || videoDevices[0].deviceId;
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        // facingMode: 'environment',
                        deviceId: { exact: selectDeviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                    },
                });
                video.srcObject = stream;
            }
            // capture
            btnCaptureCamera.addEventListener('click', () => {
                console.log('runn');
                // Ki·ªÉm tra video c√≥ ƒëang stream kh√¥ng
                if (!video.srcObject) {
                    alert('Camera ch∆∞a ƒë∆∞·ª£c m·ªü!');
                    return;
                }
                //
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                tempImage = canvas.toDataURL('image/jpeg');
                preview.src = tempImage;
                // stopCamera(); //ko stop neu muon chup lai
                document.getElementById('cameraBox').style.display = 'none';
                document.getElementById('previewBox').style.display = 'block';
            });


            // stop
            function stopCamera() {
                stream?.getTracks().forEach((track) => track.stop());
            }
            // recape
            // Ch·ª©c nƒÉng retake (ch·ª•p l·∫°i)
            btnRetake.addEventListener('click', async () => {
                console.log('Retake button clicked');

                // reset UI
                document.getElementById('previewBox').style.display = 'none';
                document.getElementById('cameraBox').style.display = 'block';

                tempImage = null;

                // n·∫øu stream c√≤n track ch·∫°y ‚Üí resume
                if (stream && stream.getTracks().some((t) => t.readyState === 'live')) {
                    video.srcObject = stream;
                    await video.play(); // üî¥ C·ª∞C QUAN TR·ªåNG
                } else {
                    // n·∫øu stream ch·∫øt ‚Üí m·ªü l·∫°i camera
                    await openCamera();
                    await video.play();
                }
            });
            //
            document.querySelector('#btn_cta_openmodal').addEventListener('click', ()=>{
                openModal();
            })
            document.querySelector('#btn_close_modal').addEventListener('click', ()=>{
                closeModal();
            })
            function openModal() {
                document.body.classList.add('overflow-hidden');
                modal.classList.remove('hidden');
                openCamera();

                setTimeout(() => {
                    modalBox.classList.remove('scale-95', 'opacity-0');
                    modalBox.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeModal() {
                document.body.classList.remove('overflow-hidden');
                modalBox.classList.add('scale-95', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
            // X·ª≠ l√Ω s·ª± ki·ªán click cho c√°c n√∫t ch√≠nh
            btnCheckin.addEventListener('click', (ev) => {
                const payload = {
                    code: document.querySelector('#code_hidden').value.trim(),
                };
                // alert(payload)
                $.ajax({
                    url: `/tool-checkin/check-in`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: (res) => {
                        console.log(res);
                        if (res.success) {
                            document.location.reload();
                        }
                    },
                    error: (xhr, status, err) => console.log(xhr.responseJSON?.mess || 'Server error'),
                });
            });
        });
    </script>
</body>
